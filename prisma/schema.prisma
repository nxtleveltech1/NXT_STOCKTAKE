generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model StockItem {
  id             String    @id @default(cuid())
  organizationId String?   // Clerk org id – NXT STOCK
  odooId         Int       @unique
  odooProductId  Int?      // product.product id in Odoo
  sku            String
  name           String
  category       String?
  location       String
  warehouse      String?
  expectedQty    Float
  reservedQty    Float?
  availableQty   Float?
  countedQty     Float?
  variance       Float?
  status         String    @default("pending") // pending | counted | variance | verified
  lastCountedBy  String?
  lastCountedAt  DateTime?
  barcode        String?
  uom            String?
  serialNumber   String?
  owner          String?
  supplier       String?   // Primary supplier name from Odoo
  supplierId     Int?      // Odoo partner_id of primary supplier
  listPrice      Float?    // Sales price from Odoo
  costPrice      Float?    // Standard cost from Odoo
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([organizationId])
  @@index([location])
  @@index([status])
  @@index([supplier])
  @@index([sku])
  @@index([barcode])
}

model StockSession {
  id                 String    @id @default(cuid())
  organizationId     String?   // Clerk org id – sessions scoped to team
  name               String
  status             String    @default("live") // live | paused | completed
  startedAt          DateTime  @default(now())
  pausedAt           DateTime? // when status set to paused
  totalPausedSeconds Int       @default(0) // accumulated pause duration
  location           String?
  totalItems         Int       @default(0)
  countedItems       Int       @default(0)
  varianceItems      Int       @default(0)
  verifiedItems      Int       @default(0)
  teamMembers        Int       @default(0)
  createdAt          DateTime  @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
}

model StockActivity {
  id             String   @id @default(cuid())
  organizationId String?
  sessionId      String?
  type           String   // count | variance | verify | join | zone_complete
  message        String
  userId         String?  // Clerk user id
  userName       String?
  zone           String?
  itemId         String?  // StockItem id when type is count/variance/verify
  createdAt      DateTime @default(now())

  @@index([organizationId])
  @@index([sessionId])
  @@index([createdAt(sort: Desc)])
}

model ZoneAssignment {
  id             String   @id @default(cuid())
  organizationId String?
  userId         String   // Clerk user id
  zoneCode       String   // e.g. "NXT/NXT STOCK"
  sessionId      String?
  createdAt      DateTime @default(now())

  @@unique([organizationId, zoneCode])
  @@index([organizationId])
}

model StockIssue {
  id             String    @id @default(cuid())
  organizationId String?
  sessionId      String?
  title          String
  description    String?
  status         String    @default("open") // open | in_progress | resolved | closed
  priority       String    @default("medium") // low | medium | high | critical
  category       String?
  zone           String?
  itemId         String?
  reporterId     String
  reporterName   String
  assigneeId     String?
  assigneeName   String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  resolvedAt     DateTime?

  stockIssueComments StockIssueComment[]

  @@index([organizationId])
  @@index([sessionId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model StockIssueComment {
  id        String     @id @default(cuid())
  issueId   String
  issue     StockIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  userId    String
  userName  String
  body      String
  createdAt DateTime   @default(now())

  @@index([issueId])
}
